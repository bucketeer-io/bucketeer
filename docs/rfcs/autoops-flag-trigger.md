# Summary

We will implement flag triggers feature that enables users integrate Bucketeer with their system or tools. Basically, it
will let user turn on/off the feature flag based on user's system or tools status.

## Implementation

### Infra

* Add a new table `flag_triggers` to store the flag triggers data.

```sql
CREATE TABLE `flag_triggers`
(
    `id`                    varchar(255) NOT NULL,
    `feature_id`            varchar(255) NOT NULL,
    `environment_namespace` varchar(255) NOT NULL,
    `name`                  VARCHAR(255) NOT NULL default '',
    `type`                  int          NOT NULL,
    `action`                tinyint(1) NOT NULL,
    `description`           text         NOT NULL default '',
    `trigger_times`         int          NOT NULL,
    `last_triggered_at`     bigint       NOT NULL,
    `uuid`                  varchar(512) NOT NULL default '',
    `disabled`              tinyint(1) NOT NULL DEFAULT '0',
    `deleted`               tinyint(1) NOT NULL DEFAULT '0',
    `created_at`            bigint       NOT NULL,
    `updated_at`            bigint       NOT NULL,
    PRIMARY KEY (`id`, `environment_namespace`),
    CONSTRAINT `foreign_flag_triggers_feature_id_environment_namespace` FOREIGN KEY (`feature_id`, `environment_namespace`) REFERENCES `feature` (`id`, `environment_namespace`)
)ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;
```

Table explanation:\
`id`: The unique ID of the flag trigger.\
`feature_id`: The ID of the feature. \
`environment_namespace`: The namespace of the environment.\
`name`: The name of the flag trigger.\
`type`: The type of the flag trigger, it can be **webhook**, etc.\
`action`: The action of the flag trigger, it can be turned on(1)/off(0) the feature flag.\
`description`: The description of the flag trigger.\
`trigger_times`: The times of the flag trigger has been triggered. \
`last_triggered_at`: The last time of the flag trigger has been triggered.\
`uuid`: The uuid of the flag trigger. It will be used to create and reset the trigger url.\
`disabled`: The flag trigger is disabled or not.\
`deleted`: The flag trigger is deleted or not.

* Reuse the current implementation to encrypt/decrypt the URL.

### AutoOps Server

* Add new API to manage the flag triggers.
* As we are supporting webhook trigger first, but in the feature we will support more trigger types, so we need to
  design the trigger architecture to support more trigger types. But one thing is that we should make the trigger
  architecture simple and easy to use.

#### AutoOps Flag Trigger API

- Create a new flag trigger

```Grpc
rpc CreateFlagTrigger(CreateFlagTriggerRequest) returns (CreateFlagTriggerResponse) {}
```

```proto
message CreateFlagTriggerRequest {
    string feature_id = 1;
    string environment_namespace = 2;
    string name = 3;
    int32 type = 4;
    int32 action = 5;
    string description = 6;
}
```

- Update a flag trigger

This update API may not be provided to the user. Because the real use case is create a new flag trigger and then reset
the trigger url or just delete the flag trigger.

```Grpc
rpc UpdateFlagTrigger(UpdateFlagTriggerRequest) returns (UpdateFlagTriggerResponse) {}
```

```proto
message UpdateFlagTriggerRequest {
    string id = 1;
    string feature_id = 2;
    string environment_namespace = 3;
    string name = 4;
    int32 type = 5;
    int32 action = 6;
    string description = 7;
}
```

- Reset a flag trigger

```Grpc
rpc ResetFlagTrigger(ResetFlagTriggerRequest) returns (ResetFlagTriggerResponse) {}
```

```proto
message ResetFlagTriggerRequest {
    string id = 1;
}
```

- Disable a flag trigger

```Grpc
rpc DisableFlagTrigger(DisableFlagTriggerRequest) returns (DisableFlagTriggerResponse) {}
```

```proto
message DisableFlagTriggerRequest {
    string id = 1;
}
```

- Delete a flag trigger

```Grpc
rpc DeleteFlagTrigger(DeleteFlagTriggerRequest) returns (DeleteFlagTriggerResponse) {}
```

```proto
message DeleteFlagTriggerRequest {
    string id = 1;
}
```

- Get a flag trigger

```Grpc
rpc GetFlagTrigger(GetFlagTriggerRequest) returns (GetFlagTriggerResponse) {}
```

```proto
message GetFlagTriggerRequest {
    string id = 1;
}
```

- List flag triggers

```Grpc
rpc ListFlagTriggers(ListFlagTriggersRequest) returns (ListFlagTriggersResponse) {}
```

```proto
message ListFlagTriggersRequest {
    string feature_id = 1;
    string environment_namespace = 2;
    int32 page = 3;
    int32 page_size = 4;
}
```

#### AutoOps Trigger: WebHook

First, we will provide an endpoint to receive the trigger request, and then we will trigger the feature flag based on
the trigger request. The trigger request will be sent by the user's system or tools.

The trigger url secret is generated by the AutoOps server, and it will be encrypted from **trigger id**, **flag id**, *
*action** of the flag trigger and **a random uuid** generated by `"github.com/bucketeer-io/bucketeer/pkg/uuid"`.

* How to generate the trigger url secret?

Use the following struct to as secret data:

```go
package flagtrigger

type FlagTriggerSecret struct {
	ID        string `json:"id"`
	FeatureID string `json:"feature_id"`
	Action    int    `json:"action"`
	UUID      string `json:"uuid"`
}

```

Then encrypt the secret data by the following code:

```
trigger_url_secret = crypto.EncrypterDecrypter.Encrypt(FlagTriggerSecret)
```

* What does the trigger url look like?

```curl
curl -X POST https://bucketeer.io/trigger/${trigger_url_secret}
```

* When trigger url been called, how to check the trigger url secret?

First, decrypt the trigger url secret by the following code:

```
flagTriggerSecret = crypto.EncrypterDecrypter.Decrypt(trigger_url_secret)
```

Then check the decrypted trigger url secret is valid or not by the following steps:

1. Query database by `flagTriggerSecret.ID` to get the flag trigger data `flagTrigger`.
2. Check `flagTriggerSecret.FeatureID` is equal to `flagTrigger.FeatureID`, `flagTriggerSecret.Action` is
   equal to `flagTrigger.Action` and `flagTriggerSecret.UUID` is equal to `flagTrigger.UUID`.
3. If the above conditions are all true, then call the `feature` API to turn on/off the feature flag base on
   the `flagTriggerSecret.Action`.

* How to reset the trigger url?

When reset the trigger url, we need to generate a new `uuid`, then update the `flag_trigger`.`uuid` field by the
new `uuid`, and then encrypt the new `flagTriggerSecret` by the following code:

```
trigger_url_secret = crypto.EncrypterDecrypter.Encrypt(FlagTriggerSecret)
```

Then return the new trigger url to the user.

* Only show the trigger url to the user for the first time.

    - When the user creates a new flag trigger, we will generate a new `uuid` and encrypt the `flagTriggerSecret` as the
      above steps, and then return the trigger url to the user.
    - When the user reset the trigger url, we will generate a new `uuid` and encrypt the `flagTriggerSecret` as the
      above steps, and then return the trigger url to the user.
    - In the `ListFlagTrigger` and `GetFlagTrigger` API response, we will return partial masked trigger url to the user.