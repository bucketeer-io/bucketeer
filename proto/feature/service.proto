// Copyright 2025 The Bucketeer Authors.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package bucketeer.feature;
option go_package = "github.com/bucketeer-io/bucketeer/proto/feature";

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/wrappers.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

import "proto/feature/command.proto";
import "proto/feature/feature.proto";
import "proto/feature/evaluation.proto";
import "proto/user/user.proto";
import "proto/feature/segment.proto";
import "proto/feature/flag_trigger.proto";
import "proto/feature/variation.proto";
import "proto/feature/prerequisite.proto";
import "proto/feature/rule.proto";
import "proto/feature/strategy.proto";
import "proto/feature/target.proto";

message GetFeatureRequest {
  string id = 1;
  reserved 2;
  string environment_id = 3;
}

message GetFeatureResponse {
  Feature feature = 1;
}

message GetFeaturesRequest {
  reserved 1;
  repeated string ids = 2;
  string environment_id = 3;
}

message GetFeaturesResponse {
  repeated Feature features = 1;
}

message ListFeaturesRequest {
  enum OrderBy {
    DEFAULT = 0;
    NAME = 1;
    CREATED_AT = 2;
    UPDATED_AT = 3;
    TAGS = 4;
    ENABLED = 5;
  }
  enum OrderDirection {
    ASC = 0;
    DESC = 1;
  }
  int64 page_size = 1;
  string cursor = 2;
  repeated string tags = 3;
  OrderBy order_by = 4;
  OrderDirection order_direction = 5;
  reserved 6;
  string maintainer = 7;
  google.protobuf.BoolValue enabled = 8;
  google.protobuf.BoolValue has_experiment = 9;
  string search_keyword = 10;
  google.protobuf.BoolValue archived = 11;
  google.protobuf.BoolValue has_prerequisites = 12;
  string environment_id = 13;
}

message ListFeaturesResponse {
  repeated Feature features = 1;
  string cursor = 2;
  int64 total_count = 3;
}

message ListEnabledFeaturesRequest {
  int64 page_size = 1;
  string cursor = 2;
  repeated string tags = 3;
  reserved 4;
  string environment_id = 5;
}

message ListEnabledFeaturesResponse {
  repeated Feature features = 1;
  string cursor = 2;
}

message CreateFeatureRequest {
  CreateFeatureCommand command = 1;
  reserved 2;
  string environment_id = 3;
}

message CreateFeatureResponse {
  Feature feature = 1;
}

message UpdateFeatureRequest {
  string comment = 1;
  string environment_id = 2;
  string id = 3;
  google.protobuf.StringValue name = 4;
  google.protobuf.StringValue description = 5;
  repeated string tags = 6;
  google.protobuf.BoolValue enabled = 7;
  google.protobuf.BoolValue archived = 8;
  repeated Variation variations = 9;
  repeated Prerequisite prerequisites = 10;
  repeated Target targets = 11;
  repeated Rule rules = 12;
  Strategy default_strategy = 13;
  google.protobuf.StringValue off_variation = 14;
}

message UpdateFeatureResponse {
  Feature feature = 1;
}

message EnableFeatureRequest {
  string id = 1;
  EnableFeatureCommand command = 2;
  reserved 3;
  string comment = 4;
  string environment_id = 5;
}

message EnableFeatureResponse {}

message DisableFeatureRequest {
  string id = 1;
  DisableFeatureCommand command = 2;
  reserved 3;
  string comment = 4;
  string environment_id = 5;
}

message DisableFeatureResponse {}

message ArchiveFeatureRequest {
  string id = 1;
  ArchiveFeatureCommand command = 2;
  reserved 3;
  string comment = 4;
  string environment_id = 5;
}

message ArchiveFeatureResponse {}

message UnarchiveFeatureRequest {
  string id = 1;
  UnarchiveFeatureCommand command = 2;
  reserved 3;
  string comment = 4;
  string environment_id = 5;
}

message UnarchiveFeatureResponse {}

message DeleteFeatureRequest {
  string id = 1;
  DeleteFeatureCommand command = 2;
  reserved 3;
  string comment = 4;
  string environment_id = 5;
}

message DeleteFeatureResponse {}

message UpdateFeatureDetailsRequest {
  string id = 1;
  RenameFeatureCommand rename_feature_command = 2;
  ChangeDescriptionCommand change_description_command = 3;
  repeated AddTagCommand add_tag_commands = 4;
  repeated RemoveTagCommand remove_tag_commands = 5;
  reserved 6;
  string comment = 7;
  string environment_id = 8;
}

message UpdateFeatureDetailsResponse {}

message UpdateFeatureVariationsRequest {
  string id = 1;
  repeated Command commands = 2;
  reserved 3;
  string comment = 4;
  string environment_id = 5;
}

message UpdateFeatureVariationsResponse {}

message UpdateFeatureTargetingRequest {
  enum From {
    UNKNOWN = 0;
    USER = 1;
    OPS = 2;
  }
  string id = 1;
  repeated Command commands = 2;
  reserved 3;
  string comment = 4;
  From from = 5;
  string environment_id = 6;
}

message UpdateFeatureTargetingResponse {}

message CloneFeatureRequest {
  string id = 1;
  CloneFeatureCommand command = 2;
  reserved 3;
  string environment_id = 4;
}

message CloneFeatureResponse {}

message CreateSegmentRequest {
  CreateSegmentCommand command = 1 [
    deprecated = true,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "deprecated"
    }
  ];
  reserved 2;
  string name = 3 [(google.api.field_behavior) = REQUIRED];
  string environment_id = 4 [(google.api.field_behavior) = REQUIRED];
  string description = 5;
}

message CreateSegmentResponse {
  Segment segment = 1;
}

message GetSegmentRequest {
  string id = 1 [(google.api.field_behavior) = REQUIRED];
  reserved 2;
  string environment_id = 3 [(google.api.field_behavior) = REQUIRED];
}

message GetSegmentResponse {
  Segment segment = 1;
}

message ListSegmentsRequest {
  enum OrderBy {
    DEFAULT = 0;
    NAME = 1;
    CREATED_AT = 2;
    UPDATED_AT = 3;
    CONNECTIONS = 4;
  }
  enum OrderDirection {
    ASC = 0;
    DESC = 1;
  }
  int64 page_size = 1;
  string cursor = 2;
  reserved 3;
  OrderBy order_by = 4;
  OrderDirection order_direction = 5;
  string search_keyword = 6;
  google.protobuf.Int32Value status = 7;
  google.protobuf.BoolValue is_in_use_status = 8;
  string environment_id = 9 [(google.api.field_behavior) = REQUIRED];
}

message ListSegmentsResponse {
  repeated Segment segments = 1;
  string cursor = 2;
  int64 total_count = 3;
}

message DeleteSegmentRequest {
  string id = 1;
  DeleteSegmentCommand command = 2 [
    deprecated = true,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "deprecated"
    }
  ];
  reserved 3;
  string environment_id = 4;
}

message DeleteSegmentResponse {}

message UpdateSegmentRequest {
  string id = 1;
  repeated Command commands = 2 [
    deprecated = true,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "deprecated"
    }
  ];
  reserved 3;
  string environment_id = 4 [(google.api.field_behavior) = REQUIRED];
  google.protobuf.StringValue name = 5;
  google.protobuf.StringValue description = 6;
}

message UpdateSegmentResponse {
  Segment segment = 1;
}

message AddSegmentUserRequest {
  string id = 1;
  AddSegmentUserCommand command = 2;
  reserved 3;
  string environment_id = 4;
}

message AddSegmentUserResponse {}

message DeleteSegmentUserRequest {
  string id = 1;
  DeleteSegmentUserCommand command = 2;
  reserved 3;
  string environment_id = 4;
}

message DeleteSegmentUserResponse {}

message GetSegmentUserRequest {
  string segment_id = 1;
  string user_id = 2;
  SegmentUser.State state = 3;
  reserved 4;
  string environment_id = 5;
}

message GetSegmentUserResponse {
  SegmentUser user = 1;
}

message ListSegmentUsersRequest {
  int64 page_size = 1;
  string cursor = 2;
  string segment_id = 3;
  google.protobuf.Int32Value state = 4;
  string user_id = 5;
  reserved 6;
  string environment_id = 7;
}

message ListSegmentUsersResponse {
  repeated SegmentUser users = 1;
  string cursor = 2;
}

message BulkUploadSegmentUsersRequest {
  reserved 1;
  string segment_id = 2;
  BulkUploadSegmentUsersCommand command = 3 [
    deprecated = true,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "deprecated"
    }
  ];
  string environment_id = 4;
  bytes data = 5
      [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
        description: "segment user ids separated by comma or new line"
      }];
  SegmentUser.State state = 6;
}

message BulkUploadSegmentUsersResponse {}

message BulkDownloadSegmentUsersRequest {
  reserved 1;
  string segment_id = 2 [(google.api.field_behavior) = REQUIRED];
  SegmentUser.State state = 3;
  string environment_id = 4 [(google.api.field_behavior) = REQUIRED];
}

message BulkDownloadSegmentUsersResponse {
  bytes data = 1;  // segment user ids separated by new line
}

message EvaluateFeaturesRequest {
  bucketeer.user.User user = 1;
  reserved 2;
  string tag = 3;
  string feature_id = 4;  // it will evaluate a single feature if set
  string environment_id = 5;
}

message EvaluateFeaturesResponse {
  bucketeer.feature.UserEvaluations user_evaluations = 1;
}

message ListTagsRequest {
  enum OrderBy {
    DEFAULT = 0;
    ID = 1;
    CREATED_AT = 2;
    UPDATED_AT = 3;
    NAME = 4;
  }
  enum OrderDirection {
    ASC = 0;
    DESC = 1;
  }
  reserved 1;
  int64 page_size = 2;
  string cursor = 3;
  OrderBy order_by = 4;
  OrderDirection order_direction = 5;
  string search_keyword = 6;
  string environment_id = 7;
}

message ListTagsResponse {
  repeated Tag tags = 1;
  string cursor = 2;
  int64 total_count = 3;
}

message CreateFlagTriggerRequest {
  reserved 1;
  CreateFlagTriggerCommand create_flag_trigger_command = 2;
  string environment_id = 3;
}

message CreateFlagTriggerResponse {
  FlagTrigger flag_trigger = 1;
  string url = 2;
}

message DeleteFlagTriggerRequest {
  string id = 1;
  reserved 2;
  DeleteFlagTriggerCommand delete_flag_trigger_command = 3;
  string environment_id = 4;
}

message DeleteFlagTriggerResponse {}

message UpdateFlagTriggerRequest {
  string id = 1;
  reserved 2;
  ChangeFlagTriggerDescriptionCommand change_flag_trigger_description_command =
      3;
  string environment_id = 4;
}

message UpdateFlagTriggerResponse {}

message EnableFlagTriggerRequest {
  string id = 1;
  reserved 2;
  EnableFlagTriggerCommand enable_flag_trigger_command = 3;
  string environment_id = 4;
}

message EnableFlagTriggerResponse {}

message DisableFlagTriggerRequest {
  string id = 1;
  reserved 2;
  DisableFlagTriggerCommand disable_flag_trigger_command = 3;
  string environment_id = 4;
}

message DisableFlagTriggerResponse {}

message ResetFlagTriggerRequest {
  string id = 1;
  reserved 2;
  ResetFlagTriggerCommand reset_flag_trigger_command = 3;
  string environment_id = 4;
}

message ResetFlagTriggerResponse {
  FlagTrigger flag_trigger = 1;
  string url = 2;
}

message GetFlagTriggerRequest {
  string id = 1;
  reserved 2;
  string environment_id = 3;
}

message GetFlagTriggerResponse {
  FlagTrigger flag_trigger = 1;
  string url = 2;
}

message ListFlagTriggersRequest {
  enum OrderBy {
    DEFAULT = 0;
    CREATED_AT = 1;
    UPDATED_AT = 2;
  }
  enum OrderDirection {
    ASC = 0;
    DESC = 1;
  }
  string feature_id = 1;
  reserved 2;
  string cursor = 3;
  int32 page_size = 4;
  OrderBy order_by = 5;
  OrderDirection order_direction = 6;
  string environment_id = 7;
}

message ListFlagTriggersResponse {
  message FlagTriggerWithUrl {
    FlagTrigger flag_trigger = 1;
    string url = 2;
  }
  repeated FlagTriggerWithUrl flag_triggers = 1;
  string cursor = 2;
  int64 total_count = 3;
}

message FlagTriggerWebhookRequest {
  string token = 1;
}

message FlagTriggerWebhookResponse {}

service FeatureService {
  rpc GetFeature(GetFeatureRequest) returns (GetFeatureResponse) {}
  rpc GetFeatures(GetFeaturesRequest) returns (GetFeaturesResponse) {}
  rpc ListFeatures(ListFeaturesRequest) returns (ListFeaturesResponse) {}
  rpc ListEnabledFeatures(ListEnabledFeaturesRequest)
      returns (ListEnabledFeaturesResponse) {}
  rpc CreateFeature(CreateFeatureRequest) returns (CreateFeatureResponse) {}
  rpc UpdateFeature(UpdateFeatureRequest) returns (UpdateFeatureResponse) {}
  rpc EnableFeature(EnableFeatureRequest) returns (EnableFeatureResponse) {
    option deprecated = true;
  }
  rpc DisableFeature(DisableFeatureRequest) returns (DisableFeatureResponse) {
    option deprecated = true;
  }
  rpc ArchiveFeature(ArchiveFeatureRequest) returns (ArchiveFeatureResponse) {}
  rpc UnarchiveFeature(UnarchiveFeatureRequest)
      returns (UnarchiveFeatureResponse) {}
  rpc DeleteFeature(DeleteFeatureRequest) returns (DeleteFeatureResponse) {}
  rpc UpdateFeatureDetails(UpdateFeatureDetailsRequest)
      returns (UpdateFeatureDetailsResponse) {}
  rpc UpdateFeatureVariations(UpdateFeatureVariationsRequest)
      returns (UpdateFeatureVariationsResponse) {}
  rpc UpdateFeatureTargeting(UpdateFeatureTargetingRequest)
      returns (UpdateFeatureTargetingResponse) {}
  rpc CloneFeature(CloneFeatureRequest) returns (CloneFeatureResponse) {}

  rpc CreateSegment(CreateSegmentRequest) returns (CreateSegmentResponse) {
    option (google.api.http) = {
      post: "/v1/segment"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Create",
      description: "Create a segment."
      tags: "segment"
      operation_id: "web.v1.segment.create"
      responses: {
        key: "400"
        value: {
          description: "Returned for bad requests that may have failed validation."
          schema: { json_schema: { ref: ".google.rpc.Status" } }
          examples: {
            key: "application/json"
            value: '{ "code": 3, "message": "invalid arguments error", "details": [] }'
          }
        }
      }
      responses: {
        key: "401"
        value: {
          description: "Request could not be authenticated (authentication required)."
          schema: { json_schema: { ref: ".google.rpc.Status" } }
          examples: {
            key: "application/json"
            value: '{ "code": 16, "message": "not authenticated", "details": [] }'
          }
        }
      }
    };
  }
  rpc GetSegment(GetSegmentRequest) returns (GetSegmentResponse) {
    option (google.api.http) = {
      get: "/v1/segment"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get",
      description: "Get a segment."
      tags: "segment"
      operation_id: "web.v1.segment.get"
      responses: {
        key: "400"
        value: {
          description: "Returned for bad requests that may have failed validation."
          schema: { json_schema: { ref: ".google.rpc.Status" } }
          examples: {
            key: "application/json"
            value: '{ "code": 3, "message": "invalid arguments error", "details": [] }'
          }
        }
      }
      responses: {
        key: "401"
        value: {
          description: "Request could not be authenticated (authentication required)."
          schema: { json_schema: { ref: ".google.rpc.Status" } }
          examples: {
            key: "application/json"
            value: '{ "code": 16, "message": "not authenticated", "details": [] }'
          }
        }
      }
    };
  }
  rpc ListSegments(ListSegmentsRequest) returns (ListSegmentsResponse) {
    option (google.api.http) = {
      get: "/v1/segments"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List",
      description: "List segments."
      tags: "segment"
      operation_id: "web.v1.segment.list"
      responses: {
        key: "400"
        value: {
          description: "Returned for bad requests that may have failed validation."
          schema: { json_schema: { ref: ".google.rpc.Status" } }
          examples: {
            key: "application/json"
            value: '{ "code": 3, "message": "invalid arguments error", "details": [] }'
          }
        }
      }
      responses: {
        key: "401"
        value: {
          description: "Request could not be authenticated (authentication required)."
          schema: { json_schema: { ref: ".google.rpc.Status" } }
          examples: {
            key: "application/json"
            value: '{ "code": 16, "message": "not authenticated", "details": [] }'
          }
        }
      }
    };
  }
  rpc DeleteSegment(DeleteSegmentRequest) returns (DeleteSegmentResponse) {
    option (google.api.http) = {
      delete: "/v1/segment"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Delete",
      description: "Delete a segment."
      tags: "segment"
      operation_id: "web.v1.segment.delete"
      responses: {
        key: "400"
        value: {
          description: "Returned for bad requests that may have failed validation."
          schema: { json_schema: { ref: ".google.rpc.Status" } }
          examples: {
            key: "application/json"
            value: '{ "code": 3, "message": "invalid arguments error", "details": [] }'
          }
        }
      }
      responses: {
        key: "401"
        value: {
          description: "Request could not be authenticated (authentication required)."
          schema: { json_schema: { ref: ".google.rpc.Status" } }
          examples: {
            key: "application/json"
            value: '{ "code": 16, "message": "not authenticated", "details": [] }'
          }
        }
      }
    };
  }
  rpc UpdateSegment(UpdateSegmentRequest) returns (UpdateSegmentResponse) {
    option (google.api.http) = {
      patch: "/v1/segment"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Update",
      description: "Update a segment."
      tags: "segment"
      operation_id: "web.v1.segment.update"
      responses: {
        key: "400"
        value: {
          description: "Returned for bad requests that may have failed validation."
          schema: { json_schema: { ref: ".google.rpc.Status" } }
          examples: {
            key: "application/json"
            value: '{ "code": 3, "message": "invalid arguments error", "details": [] }'
          }
        }
      }
      responses: {
        key: "401"
        value: {
          description: "Request could not be authenticated (authentication required)."
          schema: { json_schema: { ref: ".google.rpc.Status" } }
          examples: {
            key: "application/json"
            value: '{ "code": 16, "message": "not authenticated", "details": [] }'
          }
        }
      }
    };
  }

  rpc AddSegmentUser(AddSegmentUserRequest) returns (AddSegmentUserResponse) {
    option deprecated = true;
  }
  rpc DeleteSegmentUser(DeleteSegmentUserRequest)
      returns (DeleteSegmentUserResponse) {
    option deprecated = true;
  }
  rpc GetSegmentUser(GetSegmentUserRequest) returns (GetSegmentUserResponse) {
    option deprecated = true;
  }
  rpc ListSegmentUsers(ListSegmentUsersRequest)
      returns (ListSegmentUsersResponse) {}
  rpc BulkUploadSegmentUsers(BulkUploadSegmentUsersRequest)
      returns (BulkUploadSegmentUsersResponse) {
    option (google.api.http) = {
      post: "/v1/segment_users/bulk_upload"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Bulk upload",
      description: "Bulk upload segment users."
      tags: "segment"
      operation_id: "web.v1.segment_users.bulk_upload"
      responses: {
        key: "400"
        value: {
          description: "Returned for bad requests that may have failed validation."
          schema: { json_schema: { ref: ".google.rpc.Status" } }
          examples: {
            key: "application/json"
            value: '{ "code": 3, "message": "invalid arguments error", "details": [] }'
          }
        }
      }
      responses: {
        key: "401"
        value: {
          description: "Request could not be authenticated (authentication required)."
          schema: { json_schema: { ref: ".google.rpc.Status" } }
          examples: {
            key: "application/json"
            value: '{ "code": 16, "message": "not authenticated", "details": [] }'
          }
        }
      }
    };
  }
  rpc BulkDownloadSegmentUsers(BulkDownloadSegmentUsersRequest)
      returns (BulkDownloadSegmentUsersResponse) {
    option (google.api.http) = {
      get: "/v1/segment_users/bulk_download"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Bulk download",
      description: "Bulk download segment users."
      tags: "segment"
      operation_id: "web.v1.segment_users.bulk_download"
      responses: {
        key: "400"
        value: {
          description: "Returned for bad requests that may have failed validation."
          schema: { json_schema: { ref: ".google.rpc.Status" } }
          examples: {
            key: "application/json"
            value: '{ "code": 3, "message": "invalid arguments error", "details": [] }'
          }
        }
      }
      responses: {
        key: "401"
        value: {
          description: "Request could not be authenticated (authentication required)."
          schema: { json_schema: { ref: ".google.rpc.Status" } }
          examples: {
            key: "application/json"
            value: '{ "code": 16, "message": "not authenticated", "details": [] }'
          }
        }
      }
    };
  }
  rpc EvaluateFeatures(EvaluateFeaturesRequest)
      returns (EvaluateFeaturesResponse) {}
  rpc ListTags(ListTagsRequest) returns (ListTagsResponse) {}
  rpc CreateFlagTrigger(CreateFlagTriggerRequest)
      returns (CreateFlagTriggerResponse) {}
  rpc UpdateFlagTrigger(UpdateFlagTriggerRequest)
      returns (UpdateFlagTriggerResponse) {}
  rpc EnableFlagTrigger(EnableFlagTriggerRequest)
      returns (EnableFlagTriggerResponse) {}
  rpc DisableFlagTrigger(DisableFlagTriggerRequest)
      returns (DisableFlagTriggerResponse) {}
  rpc ResetFlagTrigger(ResetFlagTriggerRequest)
      returns (ResetFlagTriggerResponse) {}
  rpc DeleteFlagTrigger(DeleteFlagTriggerRequest)
      returns (DeleteFlagTriggerResponse) {}
  rpc GetFlagTrigger(GetFlagTriggerRequest) returns (GetFlagTriggerResponse) {}
  rpc ListFlagTriggers(ListFlagTriggersRequest)
      returns (ListFlagTriggersResponse) {}
  rpc FlagTriggerWebhook(FlagTriggerWebhookRequest)
      returns (FlagTriggerWebhookResponse) {
    option (google.api.http) = {
      post: "/webhook/triggers/{token}"
    };
  }
}
