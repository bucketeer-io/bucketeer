version: '3.8'

services:
  mysql:
    image: mysql:${MYSQL_VERSION:-8.0}
    container_name: bucketeer-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: bucketeer
      MYSQL_USER: bucketeer
      MYSQL_PASSWORD: bucketeer
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init-db:/docker-entrypoint-initdb.d
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "bucketeer", "-pbucketeer"]
      timeout: 20s
      retries: 10
    networks:
      - bucketeer

  redis:
    image: redis:${REDIS_VERSION:-7-alpine}
    container_name: bucketeer-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      timeout: 3s
      retries: 5
    networks:
      - bucketeer

  # Database migration service
  migration:
    image: ghcr.io/bucketeer-io/bucketeer-migration:${BUCKETEER_MIGRATION_VERSION:-localenv}
    container_name: bucketeer-migration
    depends_on:
      mysql:
        condition: service_healthy
    command: 
      - migrate
      - apply
      - -u
      - mysql://bucketeer:bucketeer@mysql:3306/bucketeer
    networks:
      - bucketeer
    restart: "no"

  # Web backend service (serves frontend + backend API)
  web:
    image: ghcr.io/bucketeer-io/bucketeer-web:${BUCKETEER_WEB_VERSION:-${BUCKETEER_VERSION:-localenv}}
    container_name: bucketeer-web
    depends_on:
      migration:
        condition: service_completed_successfully
    command: ["server"]
    environment:
      - BUCKETEER_TEST_ENABLED=true
      - BUCKETEER_WEB_MYSQL_USER=bucketeer
      - BUCKETEER_WEB_MYSQL_PASS=bucketeer
      - BUCKETEER_WEB_MYSQL_HOST=mysql
      - BUCKETEER_WEB_MYSQL_PORT=3306
      - BUCKETEER_WEB_MYSQL_DB_NAME=bucketeer
      - BUCKETEER_WEB_PERSISTENT_REDIS_SERVER_NAME=persistent-redis
      - BUCKETEER_WEB_PERSISTENT_REDIS_ADDR=redis:6379
      - BUCKETEER_WEB_PERSISTENT_REDIS_POOL_MAX_IDLE=25
      - BUCKETEER_WEB_PERSISTENT_REDIS_POOL_MAX_ACTIVE=25
      - BUCKETEER_WEB_NON_PERSISTENT_REDIS_SERVER_NAME=non-persistent-redis
      - BUCKETEER_WEB_NON_PERSISTENT_REDIS_ADDR=redis:6379
      - BUCKETEER_WEB_NON_PERSISTENT_REDIS_POOL_MAX_IDLE=25
      - BUCKETEER_WEB_NON_PERSISTENT_REDIS_POOL_MAX_ACTIVE=25
      - BUCKETEER_WEB_PUBSUB_TYPE=redis-stream
      - BUCKETEER_WEB_PUBSUB_REDIS_SERVER_NAME=non-persistent-redis
      - BUCKETEER_WEB_PUBSUB_REDIS_ADDR=redis:6379
      - BUCKETEER_WEB_PUBSUB_REDIS_POOL_SIZE=25
      - BUCKETEER_WEB_PUBSUB_REDIS_MIN_IDLE=25
      - BUCKETEER_WEB_PUBSUB_REDIS_PARTITION_COUNT=16
      - BUCKETEER_WEB_PROJECT=bucketeer-test
      - BUCKETEER_WEB_BIGQUERY_DATA_SET=bucketeer
      - BUCKETEER_WEB_BIGQUERY_DATA_LOCATION=bucketeer
      - BUCKETEER_WEB_DOMAIN_TOPIC=domain
      - BUCKETEER_WEB_BULK_SEGMENT_USERS_RECEIVED_TOPIC=bulk-segment-users-received
      - BUCKETEER_WEB_GRPC_GATEWAY_PORT=9089
      - BUCKETEER_WEB_HEALTH_CHECK_SERVICE_PORT=8000
      - BUCKETEER_WEB_ACCOUNT_SERVICE_PORT=9091
      - BUCKETEER_WEB_AUTH_SERVICE_PORT=9092
      - BUCKETEER_WEB_AUDIT_LOG_SERVICE_PORT=9093
      - BUCKETEER_WEB_AUTO_OPS_SERVICE_PORT=9094
      - BUCKETEER_WEB_ENVIRONMENT_SERVICE_PORT=9095
      - BUCKETEER_WEB_EVENT_COUNTER_SERVICE_PORT=9096
      - BUCKETEER_WEB_EXPERIMENT_SERVICE_PORT=9097
      - BUCKETEER_WEB_FEATURE_SERVICE_PORT=9098
      - BUCKETEER_WEB_NOTIFICATION_SERVICE_PORT=9100
      - BUCKETEER_WEB_PUSH_SERVICE_PORT=9101
      - BUCKETEER_WEB_TAG_SERVICE_PORT=9104
      - BUCKETEER_WEB_TEAM_SERVICE_PORT=9107
      - BUCKETEER_WEB_WEB_CONSOLE_SERVICE_PORT=9102
      - BUCKETEER_WEB_DASHBOARD_SERVICE_PORT=9103
      - BUCKETEER_WEB_CODE_REFERENCE_SERVICE_PORT=9105
      - BUCKETEER_WEB_UNIFIED_GATEWAY_PORT=9106
      - BUCKETEER_WEB_METRICS_PORT=9002
      - BUCKETEER_WEB_TIMEZONE=UTC
      - BUCKETEER_WEB_LOG_LEVEL=info
      - BUCKETEER_WEB_PROFILE=false
      - BUCKETEER_WEB_GCP_TRACE_ENABLED=false
      - BUCKETEER_WEB_USE_MYSQL=true
      - BUCKETEER_WEB_CLOUD_SERVICE=gcp
      - BUCKETEER_WEB_WEBHOOK_BASE_URL=https://localhost
      - BUCKETEER_WEB_WEBHOOK_KMS_RESOURCE_NAME=vault
      - BUCKETEER_WEB_OAUTH_PUBLIC_KEY=/usr/local/oauth-key/public.pem
      - BUCKETEER_WEB_OAUTH_PRIVATE_KEY=/usr/local/oauth-key/private.pem
      - BUCKETEER_WEB_OAUTH_CONFIG_PATH=/usr/local/oauth-config/oauth-config.json
      - BUCKETEER_WEB_CERT=/usr/local/certs/service/tls.crt
      - BUCKETEER_WEB_KEY=/usr/local/certs/service/tls.key
      - BUCKETEER_WEB_SERVICE_TOKEN=/usr/local/service-token/token
      - BUCKETEER_WEB_EMAIL_FILTER=
      - BUCKETEER_WEB_WEB_CONSOLE_ENV_JS_PATH=/usr/local/static/js
      # Internal gRPC client connections (routed through nginx gRPC proxy)
      - BUCKETEER_WEB_ACCOUNT_SERVICE=nginx:443
      - BUCKETEER_WEB_AUTH_SERVICE=nginx:443
      - BUCKETEER_WEB_BATCH_SERVICE=batch:9000
      - BUCKETEER_WEB_ENVIRONMENT_SERVICE=nginx:443
      - BUCKETEER_WEB_EXPERIMENT_SERVICE=nginx:443
      - BUCKETEER_WEB_FEATURE_SERVICE=nginx:443
      - BUCKETEER_WEB_AUTO_OPS_SERVICE=nginx:443
      - BUCKETEER_WEB_CODE_REFERENCE_SERVICE=nginx:443
      - BUCKETEER_WEB_DATA_WAREHOUSE_CONFIG_PATH=/usr/local/datawarehouse-config/datawarehouse.yaml
    volumes:
      - ../tools/dev/cert/tls.crt:/usr/local/certs/service/tls.crt:ro
      - ../tools/dev/cert/tls.key:/usr/local/certs/service/tls.key:ro
      - ../tools/dev/cert/service-token:/usr/local/service-token/token:ro
      - ../tools/dev/cert/oauth-public.pem:/usr/local/oauth-key/public.pem:ro
      - ../tools/dev/cert/oauth-private.pem:/usr/local/oauth-key/private.pem:ro
      - ./config/oauth-config.json:/usr/local/oauth-config/oauth-config.json:ro
      - ./config/datawarehouse.yaml:/usr/local/datawarehouse-config/datawarehouse.yaml:ro
      - ./static-files:/usr/local/static:ro
    networks:
      - bucketeer
    restart: unless-stopped

  # API Gateway service (for SDK)
  api:
    image: ghcr.io/bucketeer-io/bucketeer-api:${BUCKETEER_API_VERSION:-${BUCKETEER_VERSION:-localenv}}
    container_name: bucketeer-api
    depends_on:
      web:
        condition: service_started
    command: ["server"]
    environment:
      - BUCKETEER_API_PROJECT=bucketeer-test
      - BUCKETEER_API_GOAL_TOPIC=goal
      - BUCKETEER_API_EVALUATION_TOPIC=evaluation
      - BUCKETEER_API_USER_TOPIC=user
      - BUCKETEER_API_METRICS_TOPIC=metrics
      - BUCKETEER_API_PUBLISH_NUM_GOROUTINES=200
      - BUCKETEER_API_PUBLISH_TIMEOUT=1m
      - BUCKETEER_API_REDIS_SERVER_NAME=api-gateway
      - BUCKETEER_API_REDIS_ADDR=redis:6379
      - BUCKETEER_API_REDIS_POOL_MAX_IDLE=25
      - BUCKETEER_API_REDIS_POOL_MAX_ACTIVE=25
      - BUCKETEER_API_PUBSUB_TYPE=redis-stream
      - BUCKETEER_API_PUBSUB_REDIS_SERVER_NAME=non-persistent-redis
      - BUCKETEER_API_PUBSUB_REDIS_ADDR=redis:6379
      - BUCKETEER_API_PUBSUB_REDIS_POOL_SIZE=25
      - BUCKETEER_API_PUBSUB_REDIS_MIN_IDLE=25
      - BUCKETEER_API_PUBSUB_REDIS_PARTITION_COUNT=16
      - BUCKETEER_API_OLDEST_EVENT_TIMESTAMP=24h
      - BUCKETEER_API_FURTHEST_EVENT_TIMESTAMP=24h
      - BUCKETEER_API_PORT=9090
      - BUCKETEER_API_GRPC_GATEWAY_PORT=9089
      - BUCKETEER_API_METRICS_PORT=9002
      - BUCKETEER_API_CERT=/usr/local/certs/service/tls.crt
      - BUCKETEER_API_KEY=/usr/local/certs/service/tls.key
      - BUCKETEER_API_SERVICE_TOKEN=/usr/local/service-token/token
      - BUCKETEER_API_FEATURE_SERVICE=web:9098
      - BUCKETEER_API_ACCOUNT_SERVICE=web:9091
      - BUCKETEER_API_PUSH_SERVICE=web:9101
      - BUCKETEER_API_CODE_REF_SERVICE=web:9105
      - BUCKETEER_API_AUDIT_LOG_SERVICE=web:9093
      - BUCKETEER_API_LOG_LEVEL=info
      - BUCKETEER_API_PROFILE=false
      - BUCKETEER_API_GCP_TRACE_ENABLED=false
      - BUCKETEER_API_TRACE_SAMPLING_PROBABILITY=0.0
    volumes:
      - ../tools/dev/cert/tls.crt:/usr/local/certs/service/tls.crt:ro
      - ../tools/dev/cert/tls.key:/usr/local/certs/service/tls.key:ro
      - ../tools/dev/cert/service-token:/usr/local/service-token/token:ro
    networks:
      - bucketeer
    restart: unless-stopped

  # Batch processing service
  batch:
    image: ghcr.io/bucketeer-io/bucketeer-batch:${BUCKETEER_BATCH_VERSION:-${BUCKETEER_VERSION:-localenv}}
    container_name: bucketeer-batch
    depends_on:
      web:
        condition: service_started
    command: ["server"]
    environment:
      - BUCKETEER_BATCH_PROJECT=bucketeer-test
      - BUCKETEER_BATCH_MYSQL_USER=bucketeer
      - BUCKETEER_BATCH_MYSQL_PASS=bucketeer
      - BUCKETEER_BATCH_MYSQL_HOST=mysql
      - BUCKETEER_BATCH_MYSQL_PORT=3306
      - BUCKETEER_BATCH_MYSQL_DB_NAME=bucketeer
      - BUCKETEER_BATCH_MYSQL_DB_OPEN_CONNS=50
      - BUCKETEER_BATCH_PERSISTENT_REDIS_SERVER_NAME=batch-persistent-redis
      - BUCKETEER_BATCH_PERSISTENT_REDIS_ADDR=redis:6379
      - BUCKETEER_BATCH_PERSISTENT_REDIS_POOL_MAX_IDLE=25
      - BUCKETEER_BATCH_PERSISTENT_REDIS_POOL_MAX_ACTIVE=25
      - BUCKETEER_BATCH_NON_PERSISTENT_REDIS_SERVER_NAME=batch-non-persistent-redis
      - BUCKETEER_BATCH_NON_PERSISTENT_REDIS_ADDR=redis:6379
      - BUCKETEER_BATCH_NON_PERSISTENT_REDIS_POOL_MAX_IDLE=25
      - BUCKETEER_BATCH_NON_PERSISTENT_REDIS_POOL_MAX_ACTIVE=25
      - BUCKETEER_BATCH_PUBSUB_TYPE=redis-stream
      - BUCKETEER_BATCH_PUBSUB_REDIS_SERVER_NAME=non-persistent-redis
      - BUCKETEER_BATCH_PUBSUB_REDIS_ADDR=redis:6379
      - BUCKETEER_BATCH_PUBSUB_REDIS_POOL_SIZE=25
      - BUCKETEER_BATCH_PUBSUB_REDIS_MIN_IDLE=25
      - BUCKETEER_BATCH_PUBSUB_REDIS_PARTITION_COUNT=16
      - BUCKETEER_BATCH_PORT=9000
      - BUCKETEER_BATCH_GRPC_GATEWAY_PORT=9089
      - BUCKETEER_BATCH_METRICS_PORT=9002
      - BUCKETEER_BATCH_TIMEZONE=UTC
      - BUCKETEER_BATCH_REFRESH_INTERVAL=10m
      - BUCKETEER_BATCH_EXPERIMENT_LOCK_TTL=1m
      - BUCKETEER_BATCH_WEB_URL=http://localhost:3000
      - BUCKETEER_BATCH_CERT=/usr/local/certs/service/tls.crt
      - BUCKETEER_BATCH_KEY=/usr/local/certs/service/tls.key
      - BUCKETEER_BATCH_SERVICE_TOKEN=/usr/local/service-token/token
      - BUCKETEER_BATCH_OAUTH_PUBLIC_KEY=/usr/local/oauth-key/public.pem
      - BUCKETEER_BATCH_OAUTH_ISSUER=https://localhost
      - BUCKETEER_BATCH_OAUTH_AUDIENCE=bucketeer
      - BUCKETEER_BATCH_OAUTH_CLIENT_ID=
      - BUCKETEER_BATCH_ACCOUNT_SERVICE=web:9091
      - BUCKETEER_BATCH_NOTIFICATION_SERVICE=web:9100
      - BUCKETEER_BATCH_ENVIRONMENT_SERVICE=web:9095
      - BUCKETEER_BATCH_PUSH_SERVICE=web:9101
      - BUCKETEER_BATCH_AUTO_OPS_SERVICE=web:9094
      - BUCKETEER_BATCH_EXPERIMENT_SERVICE=web:9097
      - BUCKETEER_BATCH_EVENT_COUNTER_SERVICE=web:9096
      - BUCKETEER_BATCH_FEATURE_SERVICE=web:9098
      - BUCKETEER_BATCH_EXPERIMENT_CALCULATOR_SERVICE=localhost:9001
      - BUCKETEER_BATCH_BATCH_SERVICE=localhost:9000
      - BUCKETEER_BATCH_LOG_LEVEL=info
      - BUCKETEER_BATCH_PROFILE=false
      - BUCKETEER_BATCH_GCP_TRACE_ENABLED=false
      - BUCKETEER_BATCH_STAN_MODEL_ID=y3qsnd7m
    volumes:
      - ../tools/dev/cert/tls.crt:/usr/local/certs/service/tls.crt:ro
      - ../tools/dev/cert/tls.key:/usr/local/certs/service/tls.key:ro
      - ../tools/dev/cert/service-token:/usr/local/service-token/token:ro
      - ../tools/dev/cert/oauth-public.pem:/usr/local/oauth-key/public.pem:ro
    networks:
      - bucketeer
    restart: unless-stopped

  # Event subscriber service
  subscriber:
    image: ghcr.io/bucketeer-io/bucketeer-subscriber:${BUCKETEER_SUBSCRIBER_VERSION:-${BUCKETEER_VERSION:-localenv}}
    container_name: bucketeer-subscriber
    depends_on:
      web:
        condition: service_started
    command: ["server"]
    environment:
      - BUCKETEER_SUBSCRIBER_PROJECT=bucketeer-test
      - BUCKETEER_SUBSCRIBER_MYSQL_USER=bucketeer
      - BUCKETEER_SUBSCRIBER_MYSQL_PASS=bucketeer
      - BUCKETEER_SUBSCRIBER_MYSQL_HOST=mysql
      - BUCKETEER_SUBSCRIBER_MYSQL_PORT=3306
      - BUCKETEER_SUBSCRIBER_MYSQL_DB_NAME=bucketeer
      - BUCKETEER_SUBSCRIBER_MYSQL_DB_OPEN_CONNS=50
      - BUCKETEER_SUBSCRIBER_PERSISTENT_REDIS_SERVER_NAME=batch-persistent-redis
      - BUCKETEER_SUBSCRIBER_PERSISTENT_REDIS_ADDR=redis:6379
      - BUCKETEER_SUBSCRIBER_PERSISTENT_REDIS_POOL_MAX_IDLE=25
      - BUCKETEER_SUBSCRIBER_PERSISTENT_REDIS_POOL_MAX_ACTIVE=25
      - BUCKETEER_SUBSCRIBER_NON_PERSISTENT_REDIS_SERVER_NAME=batch-non-persistent-redis
      - BUCKETEER_SUBSCRIBER_NON_PERSISTENT_REDIS_ADDR=redis:6379
      - BUCKETEER_SUBSCRIBER_NON_PERSISTENT_REDIS_POOL_MAX_IDLE=25
      - BUCKETEER_SUBSCRIBER_NON_PERSISTENT_REDIS_POOL_MAX_ACTIVE=25
      - BUCKETEER_SUBSCRIBER_PUBSUB_TYPE=redis-stream
      - BUCKETEER_SUBSCRIBER_PUBSUB_REDIS_SERVER_NAME=non-persistent-redis
      - BUCKETEER_SUBSCRIBER_PUBSUB_REDIS_ADDR=redis:6379
      - BUCKETEER_SUBSCRIBER_PUBSUB_REDIS_POOL_SIZE=25
      - BUCKETEER_SUBSCRIBER_PUBSUB_REDIS_MIN_IDLE=25
      - BUCKETEER_SUBSCRIBER_PUBSUB_REDIS_PARTITION_COUNT=16
      - BUCKETEER_SUBSCRIBER_PORT=9000
      - BUCKETEER_SUBSCRIBER_METRICS_PORT=9002
      - BUCKETEER_SUBSCRIBER_REFRESH_INTERVAL=10m
      - BUCKETEER_SUBSCRIBER_WEB_URL=http://localhost:3000
      - BUCKETEER_SUBSCRIBER_CERT=/usr/local/certs/service/tls.crt
      - BUCKETEER_SUBSCRIBER_KEY=/usr/local/certs/service/tls.key
      - BUCKETEER_SUBSCRIBER_SERVICE_TOKEN=/usr/local/service-token/token
      - BUCKETEER_SUBSCRIBER_OAUTH_PUBLIC_KEY=/usr/local/oauth-key/public.pem
      - BUCKETEER_SUBSCRIBER_NOTIFICATION_SERVICE=web:9100
      - BUCKETEER_SUBSCRIBER_ENVIRONMENT_SERVICE=web:9095
      - BUCKETEER_SUBSCRIBER_PUSH_SERVICE=web:9101
      - BUCKETEER_SUBSCRIBER_AUTO_OPS_SERVICE=web:9094
      - BUCKETEER_SUBSCRIBER_EXPERIMENT_SERVICE=web:9097
      - BUCKETEER_SUBSCRIBER_FEATURE_SERVICE=web:9098
      - BUCKETEER_SUBSCRIBER_BATCH_SERVICE=batch:9000
      - BUCKETEER_SUBSCRIBER_LOG_LEVEL=info
      - BUCKETEER_SUBSCRIBER_PROFILE=false
      - BUCKETEER_SUBSCRIBER_GCP_TRACE_ENABLED=false
      - BUCKETEER_SUBSCRIBER_SUBSCRIBER_CONFIG=/usr/local/conf/subscribers.json
      - BUCKETEER_SUBSCRIBER_ON_DEMAND_SUBSCRIBER_CONFIG=/usr/local/conf/onDemandSubscribers.json
      - BUCKETEER_SUBSCRIBER_PROCESSORS_CONFIG=/usr/local/conf/processors.json
      - BUCKETEER_SUBSCRIBER_ON_DEMAND_PROCESSORS_CONFIG=/usr/local/conf/onDemandProcessors.json
    volumes:
      - ../tools/dev/cert/tls.crt:/usr/local/certs/service/tls.crt:ro
      - ../tools/dev/cert/tls.key:/usr/local/certs/service/tls.key:ro
      - ../tools/dev/cert/service-token:/usr/local/service-token/token:ro
      - ../tools/dev/cert/oauth-public.pem:/usr/local/oauth-key/public.pem:ro
      - ./config/subscriber-config:/usr/local/conf:ro
    networks:
      - bucketeer
    restart: unless-stopped

  # Nginx reverse proxy for routing
  nginx:
    image: nginx:${NGINX_VERSION:-1.25-alpine}
    container_name: bucketeer-nginx
    ports:
      - "80:80"     # HTTP port
      - "443:443"   # HTTPS port
    depends_on:
      - web
      - api
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/bucketeer.conf:/etc/nginx/conf.d/bucketeer.conf:ro
      - ./logs/nginx:/var/log/nginx
      - ../tools/dev/cert:/etc/nginx/certs:ro
    networks:
      - bucketeer
    restart: unless-stopped

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local

networks:
  bucketeer:
    driver: bridge 